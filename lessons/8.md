# Testes lentos

Testes automatizados servem para prover feedback rÃ¡pido Ã  times que desenvolvem software.

Testes _end-to-end_ (e2e) sÃ£o famosos por serem lentos, principalmente quando comparados com testes de APIs, ou testes de unidade.

Ã€s vezes, criarmos testes desnecessariamente lentos, ao testarmos algo e2e, quando poderÃ­amos testar, por exemplo, o _frontend_ isolado do _backend_.

Outro caso comum que torna testes mais lentos que o necessÃ¡rio Ã© navegarmos atÃ© a pÃ¡gina em teste atravÃ©s de cliques, em vez de visitarmos a pÃ¡gina em teste diretamente.

Por fim, hÃ¡ tambÃ©m as esperas desnecessÃ¡rias, sendo estas, as piores das mÃ¡s prÃ¡ticas. Ainda assim, este Ã© um tema recorrente quando se fala em testes automatizados de interface grÃ¡fica de usuÃ¡rio.

> A mensagem Ã© a seguinte. NÃ£o use `cy.wait(3000)`, `cy.wait(10000)`, ou seja lÃ¡ qual for o valor em milissegundos. Isso torna os testes mais lentos do que o necessÃ¡rio, alÃ©m de as vezes tornÃ¡-los _flaky_.
>
> O Cypress jÃ¡ possui esperas e _retries_ automÃ¡ticos por padrÃ£o, e se tal padrÃ£o nÃ£o for o suficiente para certos casos, Ã© possÃ­vel sobrescrever tais valores (_timeouts_) via configuraÃ§Ã£o, ou atÃ© mesmo, para um comando especÃ­fico.

Por exemplo, digamos que os testes executem em um ambiente com poucos recursos computacionais, e portanto, a aplicaÃ§Ã£o demora para carregar. Neste caso, imagine que ao tentar fazer login, o teste falhe no preenchimento do formulÃ¡rio, devido aos elementos de tal formulÃ¡rio ainda nÃ£o terem renderizado na pÃ¡gina.

Imaginemos um teste como o seguinte:

```js
// cypress/e2e/login.cy.js

describe('Login', () => {
  it('successfully', () => {
    cy.visit('https://example.com/login')

    // Imagine que os campos abaixo demoram para renderizer
    cy.get('[data-cy="email-field"]')
      .type(Cypress.env('user_email'))
    cy.get('[data-cy="password-field"]')
      .type(Cypress.env('user_password'))
    cy.get('button[type="submit"]')
      .click()

    cy.get('[data-cy="avatar"]')
      .should('be.visible')
  })
})
```

Uma alternativa simples para resolver tal problem Ã© sobrescrever o _timeout_ padrÃ£o para o comando em que o teste estÃ¡ falhando.

Digamos que o teste sempre falhe na hora de preencher o email do usuÃ¡rio, visto que tal campo demora para renderizar.

Uma alternativa para resolver tal problema seria a seguinte.

```js
// cypress/e2e/login.cy.js

describe('Login', () => {
  it('successfully', () => {
    cy.visit('https://example.com/login')

    cy.get('[data-cy="email-field"]', { timeout: 10000 })
      .type(Cypress.env('user_email'))
    cy.get('[data-cy="password-field"]')
      .type(Cypress.env('user_password'))
    cy.get('button[type="submit"]')
      .click()

    cy.get('[data-cy="avatar"]')
      .should('be.visible')
  })
})
```

Ou seja, em vez do Cypress esperar por no mÃ¡ximo `4000` milissegundos antes de falhar (seu _timeout_ padrÃ£o), irÃ¡ esperar um mÃ¡ximo de `10000` milissegundos, porÃ©m, se apÃ³s, digamos, `6000` milissegundos o campo aparecer, o teste irÃ¡ seguir adiante.

## ConteÃºdos sugeridos

Antes de seguir adiante, tenho algumas recomendaÃ§Ãµes de conteÃºdos sobre os assuntos discutidos acima pra te indicar:

- [Definindo fixtures para testes de frontend com Cypress](https://youtu.be/2RK3f0tGOIs)
- [Testando o frontend desacoplado do backend com Cypress](https://www.linkedin.com/posts/walmyr-lima-e-silva-filho_testando-o-frontend-desacoplado-do-backend-activity-6779095750941966336-myw8)
- [Como utilizar fixtures com Cypress para isolar os testes do frontend](https://talkingabouttesting.com/2021/02/16/como-utilizar-fixtures-com-cypress-para-isolar-os-testes-do-frontend/)
- [Por que nÃ£o se deve utilizar sleeps em testes automatizados](https://talkingabouttesting.com/2017/11/20/por-que-nao-se-deve-utilizar-sleeps-em-testes-automatizados/)
- [Unnecessary Waiting - Cypress docs](https://docs.cypress.io/guides/references/best-practices#Unnecessary-Waiting) (em inglÃªs)

## ExercÃ­cio

Abra o arquivo [`cypress/e2e/slow-tests/sample1.cy.js`](../cypress/e2e/slow-tests/sample1.cy.js) e torne-o mais rÃ¡pido mockando a API com o uso de _fixtures_.

## ExercÃ­cio extra 1

Abra o arquivo [`cypress/e2e/slow-tests/sample2.cy.js`](../cypress/e2e/slow-tests/sample2.cy.js) e em vez de navegar para a pÃ¡gina de _Sign up_ atravÃ©s da _homepage_, visite a pÃ¡gina diretamente com o uso do comando `cy.visit()`.

## ExercÃ­cio extra 2

Abra o arquivo [`cypress/e2e/slow-tests/sample3.cy.js`](../cypress/e2e/slow-tests/sample3.cy.js) e em vez de esperar sempre por 10 segundos antes de fazer a vefificaÃ§Ã£o, aumente o `timeout` do comando `cy.contains('h2', 'Ramen (sopa)')` para esperar por **no mÃ¡ximo** 10 segundos, mas seguir adiante antes de fechar os 10 segundos caso o elemento que deseja-se verificar apareÃ§a antes.

ğŸ™Š ğŸ˜ƒ

```js
cy.contains('h2', 'Ramen (sopa)', { timeout: 10000 })
```

___

Ã“timo! DiminuÃ­mos o tempo de execuÃ§Ã£o de trÃªs testes. ğŸï¸

VÃ¡ para a [aula 9](./9.md) para conhecer a nona mÃ¡ prÃ¡tica (dependÃªncia entre testes) e como lidar com ela.
